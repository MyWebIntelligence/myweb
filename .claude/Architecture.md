# MyWebIntelligenceAPI Architecture

This document outlines the architecture of the MyWebIntelligenceAPI codebase and the runtime responsibilities of each module.  
For the full documentation map and current status of parity work, refer to `INDEX_DOCUMENTATION.md`.

## 1. Repository Layout
- `app/` FastAPI application package (described in section 2).
- `scripts/` Operational tooling split into `manual/` CLI flows for API smoke tests, `admin/` bootstrap helpers such as `create_admin.py`, `config/` for ops configuration (`prometheus.yml`), `data/` fixture URL lists, and single-file utilities (`delete_all_lands.py`, `land_scenario.py`, `verify_legacy_parity.py`, `get_crawl_status.py`, `medianalyse.py`).
- `tests/` Automated suites grouped by scope (`unit/`, `integration/`, `legacy/`, `api/`, `performance/`, `robustness/`), plus `manual/` smoke scripts and `data/test.db` fixtures.
- `alembic/` Alembic environment and migration scripts; `migrations/` stores legacy artefacts.
- `_legacy/` Historical experiments and deprecated tooling kept for reference.
- `exports/` and `exports_demo/` Example export outputs generated by jobs.
- `.claude/` Team documentation snapshots and per-environment settings; `.memory/` long-form design notes and ADR-style records.
- Project tooling lives at the root: `Dockerfile`, `README.md`, `.env.example`, `pytest.ini`, and `requirements.txt`.

## 2. Application Package (`app/`)

### 2.1 Entry Points
- `main.py` Composes the FastAPI app, wires middleware, and mounts the versioned routers.
- `config.py` Centralises runtime configuration sourced from environment variables.
- `core/celery_app.py` Exposes the Celery instance used by asynchronous workers.

### 2.2 API Layer (`app/api`)
- `router.py` Registers the versioned routers and shared middleware.
- `dependencies.py` Provides FastAPI dependencies (database session, current user, pagination helpers).
- `versioning.py` Implements header-based API negotiation; `deprecation.py` surfaces sunset headers for clients.
- `v1/` Stable endpoints inside `endpoints/` grouped by resource (`lands.py`, `jobs.py`, `auth.py`, `export.py`, `paragraphs.py`, `tags.py`, `websocket.py`).
- `v2/` Iterative endpoints with revised contracts (`lands_v2.py`, `export_v2.py`, `paragraphs.py`) exposed through a dedicated router.

### 2.3 Core Modules (`app/core`)
- Crawling and extraction: `crawler_engine.py` (async), `crawler_engine_sync.py`, `content_extractor.py`, `http_client.py`.
- Media analysis: `media_processor.py`, `media_processor_sync.py` handle metadata enrichment and media-specific heuristics.
- Readable content: `readable_db.py`, `readable_simple.py`, and `websocket.py` support the readable pipeline and live updates.
- Security and configuration: `security.py` for auth helpers, `settings.py` for strongly-typed settings.
- Text analytics: `text_processing.py` streamlines scoring, dictionary operations, and paragraph generation.
- Embeddings: `embedding_providers/` defines `base_provider.py`, `registry.py`, `openai_provider.py`, and `mistral_provider.py` for pluggable vector generators.

### 2.4 Persistence Layer
- `db/` SQLAlchemy models (`models.py`), metadata (`base.py`), async session plumbing (`session.py`), and DB-level helpers (`schemas.py`).
- `crud/` Repository-style helpers aligned with each model (`crud_land.py`, `crud_expression.py`, `crud_media.py`, etc.) plus `base.py` for shared patterns.
- `schemas/` Pydantic models that validate and serialise API payloads for lands, jobs, users, paragraphs, tags, media, and authentication.

### 2.5 Domain Services (`app/services`)
- Orchestration modules encapsulating business logic: `crawling_service.py`, `dictionary_service.py`, `embedding_service.py`, `export_service.py`, `export_service_sync.py`, `llm_validation_service.py`, `media_link_extractor.py`, `readable_service.py`, `readable_celery_service.py`, `readable_simple_service.py`, and `text_processor_service.py`.
- Services coordinate between API handlers, CRUD helpers, core utilities, and background workers.

### 2.6 Task Queue (`app/tasks`)
- Crawl and readable orchestration: `crawling_task.py`, `media_analysis_task.py`, `readable_task.py`, `readable_working_task.py`, `readable_test_task.py`.
- NLP and embeddings: `embedding_tasks.py`, `text_processing_tasks.py`.
- Exports and consolidation: `export_task.py`, `export_tasks.py`, `consolidation_task.py`.

### 2.7 Utilities
- `utils/` Shared helpers such as structured logging (`logging.py`) and text helpers (`text_utils.py`).

## 3. API Versioning and Lifecycles
- `api/versioning.py` inspects `Accept` headers to route requests to `v1` or `v2`, falling back to the stable version when unspecified.
- `api/deprecation.py` emits warning headers for sunsetted routes and guides clients toward replacements.
- Version 1 remains the stable contract; version 2 introduces refined land and export endpoints while new features bed in.

## 4. Background Execution Model
- Celery workers import `core/celery_app.py`, registering all modules under `app/tasks`.
- Long-running jobs persist state in the `Job` model via CRUD helpers and stream status updates through websocket broadcasts (`core/websocket.py`) and polling endpoints (`api/v1/endpoints/jobs.py`).
- Services enqueue work with contextual metadata, ensuring traceability across pipelines and simplifying job orchestration.

## 5. Functional Pipelines
- **Crawling** `services/crawling_service.py` prepares targets, `tasks/crawling_task.py` feeds URLs into `core/crawler_engine.py`, and results persist through CRUD modules with live status updates.
- **Readable Content** `services/readable_service.py` and `readable_celery_service.py` trigger `tasks/readable_task.py` and `readable_working_task.py`, relying on `core/content_extractor.py`, Trafilatura fallbacks, and `core/readable_db.py`.
- **Media Analysis** `tasks/media_analysis_task.py` delegates to `core/media_processor.py` to enrich expressions with media metadata.
- **Embeddings** `services/embedding_service.py` dispatches `tasks/embedding_tasks.py`, which invoke providers in `core/embedding_providers/` and persist vectors via paragraph CRUD helpers.
- **Exports** `tasks/export_task.py` and `export_tasks.py` call into `services/export_service.py` to build archive artefacts under `exports/` or `exports_demo/`.

## 6. Testing and Diagnostics
- Automated tests live in `tests/` with dedicated directories for unit, integration, API regression, robustness, and performance suites; `tests/legacy/` preserves earlier workflows for parity checks.
- Python smoke scripts (`tests/manual/`) and Bash-based validation flows (`scripts/manual/`) provide reproducible end-to-end diagnostics for developers.
- Shared fixtures (`tests/data/test.db`) and helpers (`tests/utils.py`) consolidate setup logic, keeping suites consistent with production behaviours.
